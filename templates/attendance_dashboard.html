{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4>Attendance Dashboard</h4>
    <div>
        <button class="btn btn-outline-primary btn-sm me-2" onclick="loadAttendance()">Refresh</button>
        <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">Filters</h5>
        <div class="row">
            <div class="col-md-3">
                <label class="form-label">Date</label>
                <input type="date" class="form-control" id="filterDate" value="{{ today }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">User</label>
                <select class="form-select" id="filterUser">
                    <option value="">All Users</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Shift</label>
                <select class="form-select" id="filterShift">
                    <option value="">All Shifts</option>
                    <option value="1">Morning</option>
                    <option value="2">Evening</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <button class="btn btn-primary w-100" onclick="applyFilters()">Apply Filters</button>
            </div>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Today's Attendance</h5>
                <h2 class="text-primary" id="todayCount">0</h2>
                <p class="text-muted">Records Today</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Present</h5>
                <h2 class="text-success" id="presentCount">0</h2>
                <p class="text-muted">Today</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Absent</h5>
                <h2 class="text-danger" id="absentCount">0</h2>
                <p class="text-muted">Today</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Pending</h5>
                <h2 class="text-warning" id="pendingCount">0</h2>
                <p class="text-muted">Time-outs</p>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Records -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5>Attendance Records</h5>
        <button class="btn btn-primary btn-sm" onclick="markAllAbsent()">Mark All Absent</button>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>MemberID</th>
                        <th>Name</th>
                        <th>Email/UserID</th>
                        <th>Date</th>
                        <th>Shift</th>
                        <th>Time In</th>
                        <th>Time Out</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="attendanceTableBody">
                    <tr>
                        <td colspan="7" class="text-center">Loading attendance records...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Manual Attendance Modal -->
<div class="modal fade" id="manualAttendanceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manual Attendance</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="manualAttendanceForm">
                    <input type="hidden" id="attendanceUserId">
                    <div class="mb-3">
                        <label class="form-label">User</label>
                        <select class="form-select" id="manualUser" required>
                            <option value="">Select User</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Shift</label>
                        <select class="form-select" id="manualShift" required>
                            <option value="">Select Shift</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" id="manualDate" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Time In</label>
                            <input type="time" class="form-control" id="manualTimeIn">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Time Out</label>
                            <input type="time" class="form-control" id="manualTimeOut">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="manualStatus" required>
                            <option value="P">Present</option>
                            <option value="A">Absent</option>
                        </select>
                    </div>
                </form>
            </div>
            <!-- Update the modal footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="markPresent()">Mark Present</button>
                <button type="button" class="btn btn-danger" onclick="markAbsent()">Mark Absent</button>
                <button type="button" class="btn btn-primary" onclick="saveManualAttendance()">
                    Save Attendance
                </button>
            </div>
        </div>
    </div>
</div>
<script>
    let allUsers = [];
    let allShifts = [];
    let currentEditId = null;

    document.addEventListener('DOMContentLoaded', function() {
        loadAttendance();
        loadUsers();
        loadShifts();
        
        // Set today's date as default
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('filterDate').value = today;
        document.getElementById('manualDate').value = today;
    });

    async function loadAttendance() {
        try {
            const token = localStorage.getItem('authToken');
            const date = document.getElementById('filterDate').value;
            const userId = document.getElementById('filterUser').value;
            const shiftId = document.getElementById('filterShift').value;
            
            let url = `/api/v1/attendance/admin?date=${date}`;
            if (userId) url += `&user_id=${userId}`;
            if (shiftId) url += `&shift_id=${shiftId}`;

            const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const attendances = await response.json();
                updateAttendanceTable(attendances);
                updateStats(attendances);
            } else {
                showMessage('danger', 'Failed to load attendance records');
            }
        } catch (error) {
            showMessage('danger', 'Network error. Please try again.');
        }
    }

    async function loadUsers() {
        try {
            const token = localStorage.getItem('authToken');
            const response = await fetch('/api/v1/users/', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                allUsers = await response.json();
                const userSelect = document.getElementById('filterUser');
                const manualUserSelect = document.getElementById('manualUser');
                
                userSelect.innerHTML = '<option value="">All Users</option>';
                manualUserSelect.innerHTML = '<option value="">Select User</option>';
                
                allUsers.forEach(user => {
                    userSelect.innerHTML += `<option value="${user.id}">${user.member_id} - ${user.full_name}</option>`;
                    manualUserSelect.innerHTML += `<option value="${user.id}">${user.member_id} - ${user.full_name}</option>`;
                });
            }
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }

    async function loadShifts() {
        try {
            const token = localStorage.getItem('authToken');
            const response = await fetch('/api/v1/attendance/shifts', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                allShifts = await response.json();
                const manualShiftSelect = document.getElementById('manualShift');
                
                manualShiftSelect.innerHTML = '<option value="">Select Shift</option>';
                allShifts.forEach(shift => {
                    manualShiftSelect.innerHTML += `<option value="${shift.id}">${shift.name}</option>`;
                });
            }
        } catch (error) {
            console.error('Error loading shifts:', error);
        }
    }

    function updateAttendanceTable(attendances) {
        const tbody = document.getElementById('attendanceTableBody');
        tbody.innerHTML = '';

        if (attendances.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">No attendance records found</td></tr>';
            return;
        }

        attendances.forEach(attendance => {
            const user = allUsers.find(u => u.id === attendance.user_id) || {};
            const shift = allShifts.find(s => s.id === attendance.shift_id) || {};
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${user.member_id || 'N/A'}</td> <!-- NEW -->
                <td>${user.full_name || 'Unknown'}</td> <!-- NEW -->
                <td>${user.email || 'Unknown'}</td>
                <td>${attendance.attendance_date}</td>
                <td>${shift.name || 'Unknown'}</td>
                <td>${attendance.time_in ? new Date(attendance.time_in).toLocaleTimeString() : '-'}</td>
                <td>${attendance.time_out ? new Date(attendance.time_out).toLocaleTimeString() : '-'}</td>
                <td>
                    <span class="badge ${attendance.status === 'P' ? 'bg-success' : 'bg-danger'}">
                        ${attendance.status === 'P' ? 'Present' : 'Absent'}
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-success me-1" onclick="quickTimeIn(${attendance.user_id}, ${attendance.shift_id})" title="Quick Time In">
                        <i class="fas fa-sign-in-alt"></i>
                    </button>
                    <button class="btn btn-sm btn-warning me-1" onclick="quickTimeOut(${attendance.user_id}, ${attendance.shift_id})" title="Quick Time Out">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editAttendance(${attendance.id})" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteAttendance(${attendance.id})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function updateStats(attendances) {
        const todayCount = attendances.length;
        const presentCount = attendances.filter(a => a.status === 'P').length;
        const absentCount = attendances.filter(a => a.status === 'A').length;
        const pendingCount = attendances.filter(a => a.time_in && !a.time_out).length;

        document.getElementById('todayCount').textContent = todayCount;
        document.getElementById('presentCount').textContent = presentCount;
        document.getElementById('absentCount').textContent = absentCount;
        document.getElementById('pendingCount').textContent = pendingCount;
    }

    function applyFilters() {
        loadAttendance();
    }

    async function deleteAttendance(attendanceId) {
        if (!confirm('Are you sure you want to delete this attendance record?')) return;

        try {
            const token = localStorage.getItem('authToken');
            const response = await fetch(`/api/v1/attendance/admin/${attendanceId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                showMessage('success', 'Attendance record deleted successfully');
                loadAttendance();
            } else {
                showMessage('danger', 'Failed to delete attendance record');
            }
        } catch (error) {
            showMessage('danger', 'Network error. Please try again.');
        }
    }

    async function markAllAbsent() {
        if (!confirm('Mark all filtered users as absent for today?')) return;

        try {
            const token = localStorage.getItem('authToken');
            const date = document.getElementById('filterDate').value;
            
            const response = await fetch(`/api/v1/attendance/admin/mark-absent?date=${date}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                showMessage('success', 'All users marked as absent successfully');
                loadAttendance();
            } else {
                showMessage('danger', 'Failed to mark users as absent');
            }
        } catch (error) {
            showMessage('danger', 'Network error. Please try again.');
        }
    }

    function openManualAttendance(attendanceId = null) {
        currentEditId = attendanceId;
        const modal = new bootstrap.Modal(document.getElementById('manualAttendanceModal'));
        
        if (attendanceId) {
            // Edit mode - load existing data
            loadAttendanceForEdit(attendanceId);
            document.querySelector('.modal-title').textContent = 'Edit Attendance';
        } else {
            // Create mode - reset form
            resetManualForm();
            document.querySelector('.modal-title').textContent = 'Create Attendance';
        }
        
        modal.show();
    }

    async function loadAttendanceForEdit(attendanceId) {
        try {
            const token = localStorage.getItem('authToken');
            const response = await fetch(`/api/v1/attendance/admin/${attendanceId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const attendance = await response.json();
                
                // Fill form with existing data
                document.getElementById('manualUser').value = attendance.user_id;
                document.getElementById('manualShift').value = attendance.shift_id;
                document.getElementById('manualDate').value = attendance.attendance_date;
                document.getElementById('manualStatus').value = attendance.status;
                
                if (attendance.time_in) {
                    const timeIn = new Date(attendance.time_in);
                    document.getElementById('manualTimeIn').value = timeIn.toTimeString().substr(0, 5);
                }
                
                if (attendance.time_out) {
                    const timeOut = new Date(attendance.time_out);
                    document.getElementById('manualTimeOut').value = timeOut.toTimeString().substr(0, 5);
                }
                
                // Disable user and date for editing (they shouldn't change)
                document.getElementById('manualUser').disabled = true;
                document.getElementById('manualDate').disabled = true;
            }
        } catch (error) {
            showMessage('danger', 'Failed to load attendance data');
        }
    }

    function resetManualForm() {
        document.getElementById('manualAttendanceForm').reset();
        document.getElementById('manualUser').disabled = false;
        document.getElementById('manualDate').disabled = false;
        document.getElementById('manualDate').value = new Date().toISOString().split('T')[0];
    }

    async function saveManualAttendance() {
        const form = document.getElementById('manualAttendanceForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const userId = document.getElementById('manualUser').value;
        const shiftId = document.getElementById('manualShift').value;
        const attendanceDate = document.getElementById('manualDate').value;
        const timeIn = document.getElementById('manualTimeIn').value;
        const timeOut = document.getElementById('manualTimeOut').value;
        const status = document.getElementById('manualStatus').value;

        // Prepare time objects
        let timeInObj = null;
        let timeOutObj = null;

        if (timeIn) {
            timeInObj = new Date(`${attendanceDate}T${timeIn}:00`).toISOString();
        }
        
        if (timeOut) {
            timeOutObj = new Date(`${attendanceDate}T${timeOut}:00`).toISOString();
        }

        const attendanceData = {
            user_id: parseInt(userId),
            shift_id: parseInt(shiftId),
            attendance_date: attendanceDate,
            time_in: timeInObj,
            time_out: timeOutObj,
            status: status
        };

        try {
            const token = localStorage.getItem('authToken');
            let url = '/api/v1/attendance/admin';
            let method = 'POST';

            if (currentEditId) {
                // Editing existing record - use PUT
                url = `/api/v1/attendance/admin/${currentEditId}`;
                method = 'PUT';
                // For update, we don't send user_id and attendance_date
                delete attendanceData.user_id;
                delete attendanceData.attendance_date;
                // Send only the fields that can be updated
                attendanceData.time_in = timeInObj;
                attendanceData.time_out = timeOutObj;
                attendanceData.status = status;
            }

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(attendanceData)
            });

            if (response.ok) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('manualAttendanceModal'));
                modal.hide();
                
                showMessage('success', `Attendance ${currentEditId ? 'updated' : 'created'} successfully`);
                loadAttendance();
            } else {
                const error = await response.json();
                showMessage('danger', error.detail || 'Failed to save attendance');
            }
        } catch (error) {
            showMessage('danger', 'Network error. Please try again.');
        }
    }

    function editAttendance(attendanceId) {
        openManualAttendance(attendanceId);
    }

    function markPresent() {
        document.getElementById('manualStatus').value = 'P';
        const now = new Date();
        const timeString = now.toTimeString().substr(0, 5);
        
        if (!document.getElementById('manualTimeIn').value) {
            document.getElementById('manualTimeIn').value = timeString;
        }
        
        saveManualAttendance();
    }

    function markAbsent() {
        document.getElementById('manualStatus').value = 'A';
        document.getElementById('manualTimeIn').value = '';
        document.getElementById('manualTimeOut').value = '';
        saveManualAttendance();
    }

    function quickTimeIn(userId, shiftId) {
        document.getElementById('manualUser').value = userId;
        document.getElementById('manualShift').value = shiftId;
        document.getElementById('manualStatus').value = 'P';
        document.getElementById('manualTimeIn').value = new Date().toTimeString().substr(0, 5);
        openManualAttendance();
    }

    function quickTimeOut(userId, shiftId) {
        document.getElementById('manualUser').value = userId;
        document.getElementById('manualShift').value = shiftId;
        document.getElementById('manualStatus').value = 'P';
        document.getElementById('manualTimeOut').value = new Date().toTimeString().substr(0, 5);
        openManualAttendance();
    }

    function logout() {
        localStorage.removeItem('authToken');
        window.location.href = '/login';
    }
</script>
{% endblock %}