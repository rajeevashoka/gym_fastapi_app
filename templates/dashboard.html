{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4>Gym Management Dashboard</h4>
    <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Users</h5>
                <h2 class="text-primary" id="users-count">0</h2>
                <p class="text-muted">Total Users</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Gyms</h5>
                <h2 class="text-success" id="gyms-count">0</h2>
                <p class="text-muted">Total Gyms</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Pincodes</h5>
                <h2 class="text-info" id="pincodes-count">0</h2>
                <p class="text-muted">Total Pincodes</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">States/Countries</h5>
                <h2 class="text-warning" id="states-count">0</h2>
                <p class="text-muted">Total States/Countries</p>
            </div>
        </div>
    </div>
</div>

<!-- Tabs Navigation -->
<ul class="nav nav-tabs mb-4" id="dashboardTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">Users</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="gyms-tab" data-bs-toggle="tab" data-bs-target="#gyms" type="button" role="tab">Gyms</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="pincodes-tab" data-bs-toggle="tab" data-bs-target="#pincodes" type="button" role="tab">Pincodes</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="states-tab" data-bs-toggle="tab" data-bs-target="#states" type="button" role="tab">States/Countries</button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="dashboardTabsContent">
    <!-- Users Tab -->
    <div class="tab-pane fade show active" id="users" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Users</h5>
                <button class="btn btn-primary btn-sm" onclick="loadUsers()">Refresh</button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Email</th>
                                <th>Gym ID</th>
                                <th>Phone</th>
                                <th>Member</th>
                                <th>Trainer</th>
                                <th>Owner</th>
                                <th>Verified</th>
                                <th>Active</th>
                                <th>Created At</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr>
                                <td colspan="10" class="text-center">Loading users...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Gyms Tab -->
    <div class="tab-pane fade" id="gyms" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Gyms</h5>
                <button class="btn btn-primary btn-sm" onclick="loadGyms()">Refresh</button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Gym Name</th>
                                <th>Gym ID</th>
                                <th>Address</th>
                                <th>District</th>
                                <th>State/UT</th>
                                <th>Pincode</th>
                                <th>Country</th>
                                <th>Created At</th>
                            </tr>
                        </thead>
                        <tbody id="gyms-table-body">
                            <tr>
                                <td colspan="9" class="text-center">Loading gyms...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Pincodes Tab -->
    <div class="tab-pane fade" id="pincodes" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Pincodes</h5>
                <button class="btn btn-primary btn-sm" onclick="loadPincodes()">Refresh</button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Pincode</th>
                                <th>State/Country ID</th>
                            </tr>
                        </thead>
                        <tbody id="pincodes-table-body">
                            <tr>
                                <td colspan="3" class="text-center">Loading pincodes...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- States/Countries Tab -->
    <div class="tab-pane fade" id="states" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>States/Countries</h5>
                <button class="btn btn-primary btn-sm" onclick="loadStates()">Refresh</button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>State Name</th>
                                <th>Country Name</th>
                            </tr>
                        </thead>
                        <tbody id="states-table-body">
                            <tr>
                                <td colspan="3" class="text-center">Loading states/countries...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function logout() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('verifyEmail');
        window.location.href = '/login';
    }

    // Check authentication on page load
    document.addEventListener('DOMContentLoaded', function() {
        const token = localStorage.getItem('authToken');
        if (!token) {
            window.location.href = '/login';
            return;
        }
        
        // Load all data
        loadUsers();
        loadGyms();
        loadPincodes();
        loadStates();
    });

    async function loadUsers() {
        try {
            const token = localStorage.getItem('authToken');
            const response = await fetch('/api/v1/users/', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const users = await response.json();
                document.getElementById('users-count').textContent = users.length;
                
                const tbody = document.getElementById('users-table-body');
                tbody.innerHTML = '';
                
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.id}</td>
                        <td>${user.email}</td>
                        <td>${user.gym_id}</td>
                        <td>${user.phone || 'N/A'}</td>
                        <td>${user.is_member ? 'Yes' : 'No'}</td>
                        <td>${user.is_trainer ? 'Yes' : 'No'}</td>
                        <td>${user.is_owner ? 'Yes' : 'No'}</td>
                        <td>${user.is_verified ? 'Yes' : 'No'}</td>
                        <td>${user.is_active ? 'Yes' : 'No'}</td>
                        <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                document.getElementById('users-table-body').innerHTML = `
                    <tr><td colspan="10" class="text-center text-danger">Error loading users</td></tr>
                `;
            }
        } catch (error) {
            console.error('Error loading users:', error);
            document.getElementById('users-table-body').innerHTML = `
                <tr><td colspan="10" class="text-center text-danger">Error loading users</td></tr>
            `;
        }
    }

    async function loadGyms() {
        try {
            const token = localStorage.getItem('authToken');
            const response = await fetch('/api/v1/gyms/', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const gyms = await response.json();
                document.getElementById('gyms-count').textContent = gyms.length;
                
                const tbody = document.getElementById('gyms-table-body');
                tbody.innerHTML = '';
                
                gyms.forEach(gym => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${gym.id}</td>
                        <td>${gym.gym_name}</td>
                        <td>${gym.gymID}</td>
                        <td>${gym.address || 'N/A'}</td>
                        <td>${gym.district || 'N/A'}</td>
                        <td>${gym.state_ut || 'N/A'}</td>
                        <td>${gym.pincode || 'N/A'}</td>
                        <td>${gym.country || 'N/A'}</td>
                        <td>${new Date(gym.created_at).toLocaleDateString()}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                document.getElementById('gyms-table-body').innerHTML = `
                    <tr><td colspan="9" class="text-center text-danger">Error loading gyms</td></tr>
                `;
            }
        } catch (error) {
            console.error('Error loading gyms:', error);
            document.getElementById('gyms-table-body').innerHTML = `
                <tr><td colspan="9" class="text-center text-danger">Error loading gyms</td></tr>
            `;
        }
    }

    async function loadPincodes() {
        try {
            const token = localStorage.getItem('authToken');
            const response = await fetch('/api/v1/pincode/', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const pincodes = await response.json();
                document.getElementById('pincodes-count').textContent = pincodes.length;
                
                const tbody = document.getElementById('pincodes-table-body');
                tbody.innerHTML = '';
                
                pincodes.forEach(pincode => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${pincode.id}</td>
                        <td>${pincode.pincode}</td>
                        <td>${pincode.state_country_id}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                document.getElementById('pincodes-table-body').innerHTML = `
                    <tr><td colspan="3" class="text-center text-danger">Error loading pincodes</td></tr>
                `;
            }
        } catch (error) {
            console.error('Error loading pincodes:', error);
            document.getElementById('pincodes-table-body').innerHTML = `
                <tr><td colspan="3" class="text-center text-danger">Error loading pincodes</td></tr>
            `;
        }
    }

    async function loadStates() {
        try {
            const token = localStorage.getItem('authToken');
            const response = await fetch('/api/v1/state_country/', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const states = await response.json();
                document.getElementById('states-count').textContent = states.length;
                
                const tbody = document.getElementById('states-table-body');
                tbody.innerHTML = '';
                
                states.forEach(state => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${state.id}</td>
                        <td>${state.state_name}</td>
                        <td>${state.country_name}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                document.getElementById('states-table-body').innerHTML = `
                    <tr><td colspan="3" class="text-center text-danger">Error loading states/countries</td></tr>
                `;
            }
        } catch (error) {
            console.error('Error loading states:', error);
            document.getElementById('states-table-body').innerHTML = `
                <tr><td colspan="3" class="text-center text-danger">Error loading states/countries</td></tr>
            `;
        }
    }

    // Auto-refresh when tab is shown
    document.getElementById('users-tab').addEventListener('shown.bs.tab', loadUsers);
    document.getElementById('gyms-tab').addEventListener('shown.bs.tab', loadGyms);
    document.getElementById('pincodes-tab').addEventListener('shown.bs.tab', loadPincodes);
    document.getElementById('states-tab').addEventListener('shown.bs.tab', loadStates);
</script>
{% endblock %}